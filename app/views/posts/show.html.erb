<div class="max-w-2xl mx-auto">
  <div class="mb-4">
    <%= link_to posts_path, class: "text-blue-500 hover:text-blue-700" do %>
      ‚Üê Back to Feed
    <% end %>
  </div>

  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex items-start space-x-3">
      <!-- Avatar -->
      <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
        <%= @post.user.name.first.upcase %>
      </div>

      <!-- Post Content -->
      <div class="flex-1 min-w-0">
        <div class="flex items-center space-x-2">
          <h3 class="font-semibold text-gray-900">
            <%= @post.user.account&.name || @post.user.name %>
          </h3>
          <% if @post.user.account&.handle %>
            <span class="text-gray-500 text-sm">@<%= @post.user.account.handle %></span>
          <% end %>
        </div>

        <time class="text-gray-400 text-sm" datetime="<%= @post.created_at.iso8601 %>">
          <%= @post.created_at.strftime("%B %d, %Y at %l:%M %p") %>
        </time>

        <div class="mt-4">
          <p class="text-gray-900 text-lg whitespace-pre-wrap"><%= simple_format(@post.content) %></p>
        </div>

        <!-- Post Images -->
        <% if @post.images.any? %>
          <div class="mt-4">
            <div class="grid <%= @post.images.count == 1 ? 'grid-cols-1' : 'grid-cols-2' %> gap-3">
              <% @post.images.each do |image| %>
                <div class="relative">
                  <%= image_tag image.variant(resize_to_limit: [600, 600]),
                      class: "w-full max-h-96 object-cover rounded-lg cursor-pointer hover:opacity-90",
                      onclick: "openImageModal('#{url_for(image)}', '#{@post.user.name} post image')" %>
                </div>
              <% end %>
            </div>
          </div>
        <% end %>

        <!-- Action Buttons -->
        <% if @post.user == current_user %>
          <div class="flex justify-end mt-6">
            <%= link_to post_path(@post),
                method: :delete,
                data: {
                  confirm: "Are you sure you want to delete this post?"
                },
                class: "text-red-500 hover:text-red-700" do %>
              Delete Post
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Comments Section -->
  <div class="mt-6">
    <!-- Comment Form -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold mb-4">Add a Comment</h3>

      <%= form_with model: [@post, @comment], local: true, class: "space-y-4" do |form| %>
        <div>
          <%= form.text_area :content,
              placeholder: "Write a comment...",
              rows: 3,
              maxlength: 500,
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" %>
          <div class="flex justify-between items-center mt-2">
            <div class="flex space-x-2">
              <label for="comment_image" class="text-gray-500 hover:text-blue-500 p-1 rounded cursor-pointer">
                üì∑
                <%= form.file_field :image,
                    accept: "image/*",
                    class: "hidden",
                    id: "comment_image",
                    onchange: "previewCommentImage(this)" %>
              </label>
            </div>
            <p class="text-xs text-gray-500">
              <span id="comment-char-count">0</span>/500 characters
            </p>
          </div>
          <!-- Comment Image Preview -->
          <div id="comment-image-preview" class="hidden mt-2">
            <div class="relative inline-block">
              <img id="comment-preview-img" src="" class="w-24 h-24 object-cover rounded">
              <button type="button" onclick="removeCommentImage()"
                      class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hover:bg-red-600">
                √ó
              </button>
            </div>
          </div>
        </div>

        <div class="flex justify-end">
          <%= form.submit "Post Comment",
              class: "bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600",
              id: "comment-submit" %>
        </div>
      <% end %>
    </div>

    <!-- Comments Display -->
    <div class="mt-6 space-y-4">
      <h3 class="text-lg font-semibold">
        Comments (<%= @comments.count %>)
      </h3>

      <% if @comments.any? %>
        <% @comments.each do |comment| %>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-start space-x-3">
              <!-- Avatar -->
              <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                <%= comment.user.name.first.upcase %>
              </div>

              <!-- Comment Content -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center space-x-2">
                  <h4 class="font-semibold text-gray-900 text-sm">
                    <%= comment.user.account&.name || comment.user.name %>
                  </h4>
                  <% if comment.user.account&.handle %>
                    <span class="text-gray-500 text-xs">@<%= comment.user.account.handle %></span>
                  <% end %>
                  <span class="text-gray-400 text-xs">¬∑</span>
                  <time class="text-gray-400 text-xs" datetime="<%= comment.created_at.iso8601 %>">
                    <%= time_ago_in_words(comment.created_at) %> ago
                  </time>
                </div>

                <div class="mt-1">
                  <p class="text-gray-900 text-sm whitespace-pre-wrap"><%= simple_format(comment.content) %></p>
                </div>

                <!-- Comment Image -->
                <% if comment.image.attached? %>
                  <div class="mt-2">
                    <%= image_tag comment.image.variant(resize_to_limit: [200, 200]),
                        class: "max-w-32 h-auto rounded-lg cursor-pointer hover:opacity-90",
                        onclick: "openImageModal('#{url_for(comment.image)}', '#{comment.user.name} comment image')" %>
                  </div>
                <% end %>

                <!-- Comment Actions -->
                <% if comment.user == current_user %>
                  <div class="flex justify-end mt-2">
                    <%= link_to [@post, comment],
                        method: :delete,
                        data: {
                          confirm: "Are you sure you want to delete this comment?"
                        },
                        class: "text-red-500 hover:text-red-700 text-xs" do %>
                      Delete
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
          <p class="text-gray-500">No comments yet. Be the first to comment!</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Comment character counter
  const commentTextarea = document.querySelector('#comment_content');
  const commentCharCount = document.querySelector('#comment-char-count');
  const commentSubmitBtn = document.querySelector('#comment-submit');

  if (commentTextarea) {
    commentTextarea.addEventListener('input', function() {
      const length = this.value.length;
      commentCharCount.textContent = length;

      if (length > 500) {
        commentCharCount.classList.add('text-red-500');
        commentSubmitBtn.disabled = true;
      } else {
        commentCharCount.classList.remove('text-red-500');
        commentSubmitBtn.disabled = false;
      }
    });
  }

  // Comment image preview function
  function previewCommentImage(input) {
    const preview = document.getElementById('comment-image-preview');
    const previewImg = document.getElementById('comment-preview-img');

    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        preview.classList.remove('hidden');
      };
      reader.readAsDataURL(input.files[0]);
    } else {
      preview.classList.add('hidden');
    }
  }

  // Remove comment image function
  function removeCommentImage() {
    const input = document.getElementById('comment_image');
    const preview = document.getElementById('comment-image-preview');

    input.value = '';
    preview.classList.add('hidden');
  }
</script>
