<div class="max-w-2xl mx-auto">
  <div class="mb-4">
    <%= link_to posts_path, class: "text-blue-500 hover:text-blue-700" do %>
      ← Back to Feed
    <% end %>
  </div>

  <div class="bg-white rounded-lg shadow p-6">
    <div class="flex items-start space-x-3">
      <!-- Avatar -->
      <div class="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
        <%= @post.user.name.first.upcase %>
      </div>

      <!-- Post Content -->
      <div class="flex-1 min-w-0">
        <div class="flex items-center space-x-2">
          <h3 class="font-semibold text-gray-900">
            <%= @post.user.account&.name || @post.user.name %>
          </h3>
          <% if @post.user.account&.handle %>
            <span class="text-gray-500 text-sm">@<%= @post.user.account.handle %></span>
          <% end %>
        </div>

        <time class="text-gray-400 text-sm" datetime="<%= @post.created_at.iso8601 %>">
          <%= @post.created_at.strftime("%B %d, %Y at %l:%M %p") %>
        </time>

        <div class="mt-4">
          <p class="text-gray-900 text-lg whitespace-pre-wrap"><%= simple_format(@post.content) %></p>
        </div>

        <!-- Action Buttons -->
        <% if @post.user == current_user %>
          <div class="flex justify-end mt-6">
            <%= link_to post_path(@post),
                method: :delete,
                data: {
                  confirm: "Are you sure you want to delete this post?"
                },
                class: "text-red-500 hover:text-red-700" do %>
              Delete Post
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>

  <!-- Comments Section -->
  <div class="mt-6">
    <!-- Comment Form -->
    <div class="bg-white rounded-lg shadow p-6">
      <h3 class="text-lg font-semibold mb-4">Add a Comment</h3>

      <%= form_with model: [@post, @comment], local: true, class: "space-y-4" do |form| %>
        <div>
          <%= form.text_area :content,
              placeholder: "Write a comment...",
              rows: 3,
              maxlength: 500,
              class: "w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none" %>
          <p class="text-xs text-gray-500 mt-1">
            <span id="comment-char-count">0</span>/500 characters
          </p>
        </div>

        <div class="flex justify-end">
          <%= form.submit "Post Comment",
              class: "bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600",
              id: "comment-submit" %>
        </div>
      <% end %>
    </div>

    <!-- Comments Display -->
    <div class="mt-6 space-y-4">
      <h3 class="text-lg font-semibold">
        Comments (<%= @comments.count %>)
      </h3>

      <% if @comments.any? %>
        <% @comments.each do |comment| %>
          <div class="bg-white rounded-lg shadow p-4">
            <div class="flex items-start space-x-3">
              <!-- Avatar -->
              <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center text-white font-bold flex-shrink-0">
                <%= comment.user.name.first.upcase %>
              </div>

              <!-- Comment Content -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center space-x-2">
                  <h4 class="font-semibold text-gray-900 text-sm">
                    <%= comment.user.account&.name || comment.user.name %>
                  </h4>
                  <% if comment.user.account&.handle %>
                    <span class="text-gray-500 text-xs">@<%= comment.user.account.handle %></span>
                  <% end %>
                  <span class="text-gray-400 text-xs">·</span>
                  <time class="text-gray-400 text-xs" datetime="<%= comment.created_at.iso8601 %>">
                    <%= time_ago_in_words(comment.created_at) %> ago
                  </time>
                </div>

                <div class="mt-1">
                  <p class="text-gray-900 text-sm whitespace-pre-wrap"><%= simple_format(comment.content) %></p>
                </div>

                <!-- Comment Actions -->
                <% if comment.user == current_user %>
                  <div class="flex justify-end mt-2">
                    <%= link_to [@post, comment],
                        method: :delete,
                        data: {
                          confirm: "Are you sure you want to delete this comment?"
                        },
                        class: "text-red-500 hover:text-red-700 text-xs" do %>
                      Delete
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      <% else %>
        <div class="bg-gray-50 rounded-lg p-4 text-center">
          <p class="text-gray-500">No comments yet. Be the first to comment!</p>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  // Comment character counter
  const commentTextarea = document.querySelector('#comment_content');
  const commentCharCount = document.querySelector('#comment-char-count');
  const commentSubmitBtn = document.querySelector('#comment-submit');

  if (commentTextarea) {
    commentTextarea.addEventListener('input', function() {
      const length = this.value.length;
      commentCharCount.textContent = length;

      if (length > 500) {
        commentCharCount.classList.add('text-red-500');
        commentSubmitBtn.disabled = true;
      } else {
        commentCharCount.classList.remove('text-red-500');
        commentSubmitBtn.disabled = false;
      }
    });
  }
</script>
